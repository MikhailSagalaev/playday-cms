#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ PlayDay CMS Ð½Ð° VPS
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: bash scripts/deploy.sh [production|staging]

set -e

# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
ENVIRONMENT=${1:-production}
APP_DIR="/opt/playday-cms"
BACKUP_DIR="/opt/playday-cms/backups"
LOG_FILE="/opt/playday-cms/logs/deploy.log"

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

warn() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1" >> $LOG_FILE
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1" >> $LOG_FILE
    exit 1
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ playday
if [ "$USER" != "playday" ]; then
    error "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ playday: su - playday"
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð»Ð¾Ð³Ð¾Ð² ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
mkdir -p $(dirname $LOG_FILE)

log "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹ PlayDay CMS (ÑÑ€ÐµÐ´Ð°: $ENVIRONMENT)"

# 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Node.js
if ! command -v node &> /dev/null; then
    error "Node.js Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

NODE_VERSION=$(node --version)
log "Node.js: $NODE_VERSION"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ PM2
if ! command -v pm2 &> /dev/null; then
    error "PM2 Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

PM2_VERSION=$(pm2 --version)
log "PM2: $PM2_VERSION"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ PostgreSQL
if ! command -v psql &> /dev/null; then
    error "PostgreSQL Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
fi

# 2. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±ÑÐºÐ°Ð¿Ð° Ð¿ÐµÑ€ÐµÐ´ Ð´ÐµÐ¿Ð»Ð¾ÐµÐ¼
log "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ð¿ÐµÑ€ÐµÐ´ Ð´ÐµÐ¿Ð»Ð¾ÐµÐ¼..."
if [ -d "$APP_DIR" ] && [ -f "$APP_DIR/package.json" ]; then
    /usr/local/bin/playday-backup
    log "Ð‘ÑÐºÐ°Ð¿ ÑÐ¾Ð·Ð´Ð°Ð½"
else
    warn "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿"
fi

# 3. ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
log "ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
pm2 stop playday-cms 2>/dev/null || warn "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾"
pm2 delete playday-cms 2>/dev/null || warn "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² PM2"

# 4. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
cd $APP_DIR

# 5. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð° (ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹)
if [ -d ".git" ]; then
    log "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· git..."
    git fetch origin
    git reset --hard origin/main
    log "ÐšÐ¾Ð´ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½"
else
    warn "ÐÐµ git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð´Ð°"
fi

# 6. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
log "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
npm ci --production

if [ $? -ne 0 ]; then
    error "ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
fi

log "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

# 7. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
if [ ! -f ".env" ]; then
    error "Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ env.example Ð² .env Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÐµÐ³Ð¾"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
source .env

if [ -z "$DATABASE_URL" ]; then
    error "DATABASE_URL Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð² .env"
fi

if [ -z "$JWT_SECRET" ]; then
    error "JWT_SECRET Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð² .env"
fi

log "ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð°"

# 8. Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
log "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
npm run migrate

if [ $? -ne 0 ]; then
    error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹"
fi

log "ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹"

# 9. ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· Airtable (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¾)
if [ ! -z "$AIRTABLE_API_KEY" ] && [ ! -z "$AIRTABLE_BASE_ID" ]; then
    log "ÐœÐ¸Ð³Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Airtable..."
    npm run migrate:airtable
    
    if [ $? -ne 0 ]; then
        warn "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· Airtable, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð´ÐµÐ¿Ð»Ð¾Ð¹"
    else
        log "Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Airtable Ð¼Ð¸Ð³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹"
    fi
else
    warn "Airtable Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
fi

# 10. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
log "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸..."
mkdir -p uploads
mkdir -p logs
mkdir -p backups

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
chmod 755 uploads
chmod 755 logs
chmod 755 backups

log "Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹"

# 11. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
node -e "
const { testConnection } = require('./src/config/database');
testConnection().then(connected => {
    if (!connected) {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…');
        process.exit(1);
    }
    console.log('ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” ÑƒÑÐ¿ÐµÑˆÐ½Ð¾');
}).catch(err => {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ°:', err.message);
    process.exit(1);
});
"

if [ $? -ne 0 ]; then
    error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
fi

log "ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð‘Ð” Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð¾"

# 12. Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
log "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
pm2 start src/app.js --name playday-cms --env $ENVIRONMENT

if [ $? -ne 0 ]; then
    error "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
fi

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
sleep 5

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
PM2_STATUS=$(pm2 jlist | jq -r '.[] | select(.name=="playday-cms") | .pm2_env.status' 2>/dev/null || echo "unknown")

if [ "$PM2_STATUS" != "online" ]; then
    error "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ð»Ð¾ÑÑŒ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: pm2 logs playday-cms"
fi

log "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"

# 13. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
log "ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº..."
pm2 save
pm2 startup systemd -u playday --hp /home/playday

log "ÐÐ²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐº Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"

# 14. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
sleep 10

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ HTTP Ð¾Ñ‚Ð²ÐµÑ‚
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/health || echo "000")

if [ "$HTTP_STATUS" = "200" ]; then
    log "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹"
else
    warn "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð½Ð° HTTP Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ (ÑÑ‚Ð°Ñ‚ÑƒÑ: $HTTP_STATUS)"
fi

# 15. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Nginx
log "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Nginx..."
if systemctl is-active --quiet nginx; then
    log "Nginx Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
else
    warn "Nginx Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
fi

# 16. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
log "Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ..."

echo ""
echo "=== Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ==="
pm2 status

echo ""
echo "=== Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² ==="
pm2 monit --no-daemon | head -20

echo ""
echo "=== ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ ==="
pm2 logs playday-cms --lines 10

# 17. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL (ÐµÑÐ»Ð¸ Ð´Ð¾Ð¼ÐµÐ½ ÑƒÐºÐ°Ð·Ð°Ð½)
if [ ! -z "$DOMAIN" ] && [ "$DOMAIN" != "localhost" ]; then
    log "ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°: $DOMAIN"
    
    # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Nginx Ñ Ð´Ð¾Ð¼ÐµÐ½Ð¾Ð¼
    sudo sed -i "s/server_name _;/server_name $DOMAIN;/" /etc/nginx/sites-available/playday-api
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Nginx
    sudo systemctl reload nginx
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚
    sudo certbot --nginx -d $DOMAIN --non-interactive --agree-tos --email admin@$DOMAIN
    
    if [ $? -eq 0 ]; then
        log "SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
    else
        warn "ÐžÑˆÐ¸Ð±ÐºÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°"
    fi
else
    warn "Ð”Ð¾Ð¼ÐµÐ½ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½, SSL Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½"
fi

# 18. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ
log "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ..."

cat > /usr/local/bin/playday-deploy << 'EOF'
#!/bin/bash
cd /var/www/playday-cms
bash scripts/deploy.sh production
EOF

chmod +x /usr/local/bin/playday-deploy

log "Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ ÑÐ¾Ð·Ð´Ð°Ð½: /usr/local/bin/playday-deploy"

# 19. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
log "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"

echo ""
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ:"
echo "- Ð¡Ñ€ÐµÐ´Ð°: $ENVIRONMENT"
echo "- Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $APP_DIR"
echo "- PM2 ÑÑ‚Ð°Ñ‚ÑƒÑ: $(pm2 jlist | jq -r '.[] | select(.name=="playday-cms") | .pm2_env.status')"
echo "- HTTP ÑÑ‚Ð°Ñ‚ÑƒÑ: $HTTP_STATUS"
echo "- Ð’Ñ€ÐµÐ¼Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ: $(date)"

echo ""
echo "ðŸ”§ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: pm2 status"
echo "- Ð›Ð¾Ð³Ð¸: pm2 logs playday-cms"
echo "- ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³: /usr/local/bin/playday-monitor"
echo "- Ð‘ÑÐºÐ°Ð¿: /usr/local/bin/playday-backup"
echo "- ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº: pm2 restart playday-cms"
echo "- Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹: /usr/local/bin/playday-deploy"

echo ""
echo "ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑŽ:"
echo "- API: http://localhost:3000"
echo "- Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: http://localhost:3000/docs"
echo "- Health check: http://localhost:3000/health"

if [ ! -z "$DOMAIN" ] && [ "$DOMAIN" != "localhost" ]; then
    echo "- Ð’Ð½ÐµÑˆÐ½Ð¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿: https://$DOMAIN"
fi

echo ""
echo "âš ï¸  ÐÐµ Ð·Ð°Ð±ÑƒÐ´ÑŒÑ‚Ðµ:"
echo "- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð´Ð¾Ð¼ÐµÐ½ Ð² Nginx ÐµÑÐ»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¹ Ð´Ð¾Ð¼ÐµÐ½"
echo "- ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ CORS Ð´Ð»Ñ Tilda"
echo "- ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¸ Ð°Ð»ÐµÑ€Ñ‚Ñ‹"
echo "- Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿Ñ‹"

log "Ð”ÐµÐ¿Ð»Ð¾Ð¹ PlayDay CMS Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
