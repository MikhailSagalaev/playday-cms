const { query } = require('../config/database');

async function publicRoutes(fastify, options) {
  
  // GET /api/public/location/:identifier - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–∏ –ø–æ email –∏–ª–∏ record_id
  fastify.get('/location/:identifier', async (request, reply) => {
    try {
      const { identifier } = request.params;
      
      fastify.log.info(`üì• –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–∏: ${identifier}`);
      
      // –ò—â–µ–º –ø–æ email –ª–æ–∫–∞—Ü–∏–∏, record_id –∏–ª–∏ email –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (ma_email)
      const result = await query(
        `SELECT 
          id, –Ω–∞–∑–≤–∞–Ω–∏–µ, email, –∞–¥—Ä–µ—Å, –æ–ø–∏—Å–∞–Ω–∏–µ, –Ω–æ–º–µ—Ä_—Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∫–∞—Ä—Ç–∏–Ω–∫–∞,
          —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_1_—á–∞—Å, —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_2_—á–∞—Å–∞, —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_3_—á–∞—Å–∞, —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_4_—á–∞—Å–∞, —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_5_—á–∞—Å–æ–≤,
          –ø—Ä–∏–∑_1_—Ç–µ–∫—Å—Ç, –ø—Ä–∏–∑_1_–∫–∞—Ä—Ç–∏–Ω–∫–∞, –ø—Ä–∏–∑_2_—Ç–µ–∫—Å—Ç, –ø—Ä–∏–∑_2_–∫–∞—Ä—Ç–∏–Ω–∫–∞, –ø—Ä–∏–∑_3_—Ç–µ–∫—Å—Ç, –ø—Ä–∏–∑_3_–∫–∞—Ä—Ç–∏–Ω–∫–∞,
          –ø—Ä–∏–∑—ã_—Ç–µ–∫—Å—Ç, —Ä–æ–∑—ã–≥—Ä—ã—à_—Ç–∞–π–º_–∫–∞—Ä—Ç_—Ç–µ–∫—Å—Ç, –ø–æ–ø–æ–ª–Ω–∏—Ç—å_–∫–∞—Ä—Ç—É_—Å—É–º–º–∞, –¥–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ_—Ä–æ–∑—ã–≥—Ä—ã—à–∞,
          –∑–∞–≥–æ–ª–æ–≤–æ–∫_—á–µ—Ç–≤–µ—Ä–≥_–ø–æ_30, –∫–∞–∂–¥—ã–π_—á–µ—Ç–≤–µ—Ä–≥_—Ç–µ–∫—Å—Ç, —Å–∫–∏–¥–∫–∞_1, —Å–∫–∏–¥–∫–∞_2,
          —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_1_—á–∞—Å_—Ü–µ–Ω–∞, —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_2_—á–∞—Å–∞_—Ü–µ–Ω–∞, —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_3_—á–∞—Å–∞_—Ü–µ–Ω–∞, 
          —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_4_—á–∞—Å–∞_—Ü–µ–Ω–∞, —Ç–∞–π–º_–∫–∞—Ä—Ç–∞_5_—á–∞—Å–æ–≤_—Ü–µ–Ω–∞,
          –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_1, –±–æ–Ω—É—Å_1, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_2, –±–æ–Ω—É—Å_2, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_3, –±–æ–Ω—É—Å_3,
          –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_4, –±–æ–Ω—É—Å_4, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_5, –±–æ–Ω—É—Å_5, –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_6, –±–æ–Ω—É—Å_6,
          –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_1, –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_1, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_2, –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_2, 
          –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_3, –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_3, –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_4, –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_4,
          record_id, created_at, updated_at
        FROM locations 
        WHERE email = $1 OR record_id = $1 OR ma_email = $1
        ORDER BY updated_at DESC
        LIMIT 1`,
        [identifier]
      );
      
      if (result.rows.length === 0) {
        return reply.code(404).send({
          error: 'Not Found',
          message: '–õ–æ–∫–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'
        });
      }
      
      const location = result.rows[0];
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å Tilda —Ñ–æ—Ä–º–∞–º–∏
      const response = {
        records: [{
          // –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          id: location.id,
          record_id: location.record_id,
          '–ù–∞–∑–≤–∞–Ω–∏–µ': location.–Ω–∞–∑–≤–∞–Ω–∏–µ,
          'Email': location.email,
          '–ê–¥—Ä–µ—Å': location.–∞–¥—Ä–µ—Å,
          '–û–ø–∏—Å–∞–Ω–∏–µ': location.–æ–ø–∏—Å–∞–Ω–∏–µ,
          'Phone': location.–Ω–æ–º–µ—Ä_—Ç–µ–ª–µ—Ñ–æ–Ω–∞,
          '–ö–∞—Ä—Ç–∏–Ω–∫–∞ 1': location.–∫–∞—Ä—Ç–∏–Ω–∫–∞,
          
          // –¢–∞–π–º-–∫–∞—Ä—Ç—ã (–¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è)
          '—Ç–∞–π–º-–∫–∞—Ä—Ç–∞ 2 —á–∞—Å–∞': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_2_—á–∞—Å–∞,
          '—Ç–∞–π–º-–∫–∞—Ä—Ç–∞ 3 —á–∞—Å–∞': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_3_—á–∞—Å–∞,
          '—Ç–∞–π–º-–∫–∞—Ä—Ç–∞ 4 —á–∞—Å–∞': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_4_—á–∞—Å–∞,
          '—Ç–∞–π–º-–∫–∞—Ä—Ç–∞ 5 —á–∞—Å–æ–≤': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_5_—á–∞—Å–æ–≤,
          
          // –ü—Ä–∏–∑—ã (—Ä–æ–∑—ã–≥—Ä—ã—à–∏)
          '–ü—Ä–∏–∑ 1 —Ç–µ–∫—Å—Ç': location.–ø—Ä–∏–∑_1_—Ç–µ–∫—Å—Ç,
          '–ü—Ä–∏–∑ 1 –∫–∞—Ä—Ç–∏–Ω–∫–∞': location.–ø—Ä–∏–∑_1_–∫–∞—Ä—Ç–∏–Ω–∫–∞,
          '–ü—Ä–∏–∑ 2 —Ç–µ–∫—Å—Ç': location.–ø—Ä–∏–∑_2_—Ç–µ–∫—Å—Ç,
          '–ü—Ä–∏–∑ 2 –∫–∞—Ä—Ç–∏–Ω–∫–∞': location.–ø—Ä–∏–∑_2_–∫–∞—Ä—Ç–∏–Ω–∫–∞,
          '–ü—Ä–∏–∑ 3 —Ç–µ–∫—Å—Ç': location.–ø—Ä–∏–∑_3_—Ç–µ–∫—Å—Ç,
          '–ü—Ä–∏–∑ 3 –∫–∞—Ä—Ç–∏–Ω–∫–∞': location.–ø—Ä–∏–∑_3_–∫–∞—Ä—Ç–∏–Ω–∫–∞,
          '–ü—Ä–∏–∑—ã —Ç–µ–∫—Å—Ç': location.–ø—Ä–∏–∑—ã_—Ç–µ–∫—Å—Ç,
          
          // –†–æ–∑—ã–≥—Ä—ã—à
          '–†–æ–∑—ã–≥—Ä—ã—à —Ç–∞–π–º –∫–∞—Ä—Ç –Ω–∞ __ —á–∞—Å': location.—Ä–æ–∑—ã–≥—Ä—ã—à_—Ç–∞–π–º_–∫–∞—Ä—Ç_—Ç–µ–∫—Å—Ç,
          '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–∞—Ä—Ç—É –Ω–∞ —Å—É–º–º—É': location.–ø–æ–ø–æ–ª–Ω–∏—Ç—å_–∫–∞—Ä—Ç—É_—Å—É–º–º–∞,
          '–î–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞': location.–¥–∞—Ç–∞_—Å–ª–µ–¥—É—é—â–µ–≥–æ_—Ä–æ–∑—ã–≥—Ä—ã—à–∞,
          
          // –ê–∫—Ü–∏–∏
          '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–∂–¥—ã–π —á–µ—Ç–≤–µ—Ä–≥ –ü–û 30': location.–∑–∞–≥–æ–ª–æ–≤–æ–∫_—á–µ—Ç–≤–µ—Ä–≥_–ø–æ_30,
          '–ö–∞–∂–¥—ã–π —á–µ—Ç–≤–µ—Ä–≥ –≤—Å–µ –ø–æ': location.–∫–∞–∂–¥—ã–π_—á–µ—Ç–≤–µ—Ä–≥_—Ç–µ–∫—Å—Ç,
          '–°–∫–∏–¥–∫–∞ 1': location.—Å–∫–∏–¥–∫–∞_1,
          '–°–∫–∏–¥–∫–∞ 2': location.—Å–∫–∏–¥–∫–∞_2,
          
          // –¢–∞–π–º-–∫–∞—Ä—Ç—ã (—Ü–µ–Ω—ã –¥–ª—è –∞–∫—Ü–∏–π)
          '–¢–∞–π–º –∫–∞—Ä—Ç–∞ (1 —á–∞—Å)': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_1_—á–∞—Å_—Ü–µ–Ω–∞,
          '–¢–∞–π–º –∫–∞—Ä—Ç–∞ (2 —á–∞—Å)': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_2_—á–∞—Å–∞_—Ü–µ–Ω–∞,
          '–¢–∞–π–º –∫–∞—Ä—Ç–∞ (3 —á–∞—Å)': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_3_—á–∞—Å–∞_—Ü–µ–Ω–∞,
          '–¢–∞–π–º –∫–∞—Ä—Ç–∞ (4 —á–∞—Å)': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_4_—á–∞—Å–∞_—Ü–µ–Ω–∞,
          '–¢–∞–π–º –∫–∞—Ä—Ç–∞ (5 —á–∞—Å)': location.—Ç–∞–π–º_–∫–∞—Ä—Ç–∞_5_—á–∞—Å–æ–≤_—Ü–µ–Ω–∞,
          
          // –ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –±–æ–Ω—É—Å—ã (–±–æ–Ω—É—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
          '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 1': location.–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_1,
          '–ë–æ–Ω—É—Å 1': location.–±–æ–Ω—É—Å_1,
          '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 2': location.–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_2,
          '–ë–æ–Ω—É—Å 2': location.–±–æ–Ω—É—Å_2,
          '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 3': location.–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_3,
          '–ë–æ–Ω—É—Å 3': location.–±–æ–Ω—É—Å_3,
          '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 4': location.–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_4,
          '–ë–æ–Ω—É—Å 4': location.–±–æ–Ω—É—Å_4,
          '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 5': location.–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_5,
          '–ë–æ–Ω—É—Å 5': location.–±–æ–Ω—É—Å_5,
          '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ 6': location.–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ_6,
          '–ë–æ–Ω—É—Å 6': location.–±–æ–Ω—É—Å_6,
          
          // –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ (–±–æ–Ω—É—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
          '–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ 1': location.–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_1,
          '–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è 1': location.–ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_1,
          '–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ 2': location.–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_2,
          '–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è 2': location.–ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_2,
          '–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ 3': location.–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_3,
          '–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è 3': location.–ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_3,
          '–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ 4': location.–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ_4,
          '–ü—Ä–∏–≤–∏–ª–µ–≥–∏—è 4': location.–ø—Ä–∏–≤–∏–ª–µ–≥–∏—è_4
        }]
      };
      
      fastify.log.info(`‚úÖ –î–∞–Ω–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã: ${location.email}`);
      
      reply.send(response);
      
    } catch (error) {
      fastify.log.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–∏:', error);
      reply.code(500).send({
        error: 'Internal Server Error',
        message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–∏'
      });
    }
  });
}

module.exports = publicRoutes;
